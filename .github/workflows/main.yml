name: Gartic Fully Automated
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  gartic-bot:
    runs-on: windows-2019
    timeout-minutes: 360
    strategy:
      matrix:
        rdp_node: [1, 2]
    
    steps:
      - name: Configure RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="Allow-RDP" dir=in action=allow protocol=TCP localport=3389

      - name: Create User
        run: |
          $password = "admin@123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "saif123" -Password $securePass -AccountNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "saif123" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "saif123" -ErrorAction SilentlyContinue

      - name: Create HTML Auto-Script Page
        run: |
          $htmlContent = @'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Gartic Token Fetcher</title>
              <style>
                  body { 
                      background: #1a1a1a; 
                      color: #00ff00; 
                      font-family: monospace; 
                      padding: 20px;
                      font-size: 16px;
                  }
                  .status { 
                      border: 2px solid #00ff00; 
                      padding: 15px; 
                      margin: 10px 0;
                      border-radius: 5px;
                  }
                  #counter { 
                      font-size: 24px; 
                      font-weight: bold; 
                      color: #00ff00;
                  }
              </style>
          </head>
          <body>
              <div class="status">
                  <h1>ğŸš€ Gartic Token Fetcher Active</h1>
                  <p>âœ… Script Running: <span id="status">Active</span></p>
                  <p>ğŸ“Š Tokens Sent: <span id="counter">0</span></p>
                  <p>ğŸ”„ Auto-reload in: <span id="timer">50</span>s</p>
                  <p>ğŸŒ Backend: https://www.xsw.work.gd/add-token</p>
              </div>
              
              <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
              
              <script>
              (function() {
                  const TOKEN_INTERVAL = 3500;
                  const NUM_IFRAMES = 6;
                  const BACKEND_URL = 'https://www.xsw.work.gd/add-token';
                  let tokenCount = 0;
                  let reloadTimer = 50;
                  
                  // Update UI
                  setInterval(() => {
                      reloadTimer--;
                      document.getElementById('timer').textContent = reloadTimer;
                      if (reloadTimer <= 0) location.reload();
                  }, 1000);
                  
                  function sendToken(token) {
                      if (typeof token !== 'string' || token.length <= 20) return;
                      tokenCount++;
                      document.getElementById('counter').textContent = tokenCount;
                      console.log("Token #" + tokenCount + ":", token);
                      
                      fetch(BACKEND_URL, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ token })
                      }).catch(() => {});
                  }
                  
                  function createTurnstileFrames() {
                      window.addEventListener('message', function(event) {
                          if (event.data && typeof event.data === 'string') {
                              sendToken(event.data);
                          }
                      });
                      
                      for (let i = 0; i < NUM_IFRAMES; i++) {
                          const iframe = document.createElement('iframe');
                          iframe.style.display = 'none';
                          iframe.sandbox = 'allow-scripts allow-same-origin';
                          document.body.appendChild(iframe);
                          
                          const html = `
                              <!DOCTYPE html>
                              <html>
                              <head>
                                  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
                              </head>
                              <body>
                                  <div id="cf-turnstile-${i}"></div>
                                  <script>
                                      function requestToken() {
                                          try {
                                              window.turnstile.render('#cf-turnstile-${i}', {
                                                  sitekey: '0x4AAAAAABBPKaIbNwnPEfSo',
                                                  callback: function(token) {
                                                      parent.postMessage(token, '*');
                                                  }
                                              });
                                          } catch (e) {
                                              console.error('Turnstile error:', e);
                                          }
                                      }
                                      setInterval(requestToken, ${TOKEN_INTERVAL});
                                      setTimeout(requestToken, ${200 + i * 100});
                                  </script>
                              </body>
                              </html>
                          `;
                          iframe.srcdoc = html;
                      }
                  }
                  
                  // Start everything
                  setTimeout(createTurnstileFrames, 1000);
                  console.log('âœ… Gartic Token Fetcher Initialized');
              })();
              </script>
          </body>
          </html>
          '@
          
          New-Item -ItemType Directory -Force -Path "C:\GarticApp"
          $htmlContent | Out-File "C:\GarticApp\gartic1.html" -Encoding UTF8
          $htmlContent | Out-File "C:\GarticApp\gartic2.html" -Encoding UTF8

      - name: Create Startup Script
        run: |
          $script = @'
          Start-Sleep -Seconds 3
          $firefox = "C:\Program Files\Mozilla Firefox\firefox.exe"
          
          # Open two tabs with the HTML file
          Start-Process $firefox -ArgumentList "file:///C:/GarticApp/gartic1.html"
          Start-Sleep -Seconds 2
          Start-Process $firefox -ArgumentList "file:///C:/GarticApp/gartic2.html"
          '@
          
          $script | Out-File "C:\StartGartic.ps1" -Encoding UTF8
          
          # Create scheduled task
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -File C:\StartGartic.ps1"
          $trigger = New-ScheduledTaskTrigger -AtLogOn -User "saif123"
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit 0
          Register-ScheduledTask -TaskName "GarticStart" -Action $action -Trigger $trigger -Settings $settings -User "saif123" -RunLevel Highest -Force

      - name: Start Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\ts.exe"
          Start-Process "$env:TEMP\ts.exe" -ArgumentList "/quiet", "/norestart" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gartic-${{ matrix.rdp_node }}"

      - name: Launch and Display Info
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘   RDP Node ${{ matrix.rdp_node }} - Ready!              â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘  IP:   $ip            â•‘" -ForegroundColor Yellow
          Write-Host "â•‘  User: saif123                         â•‘" -ForegroundColor Yellow
          Write-Host "â•‘  Pass: admin@123                       â•‘" -ForegroundColor Yellow
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘  âœ… Firefox: Auto-starts on login      â•‘" -ForegroundColor Green
          Write-Host "â•‘  âœ… Script: Embedded (no extensions)   â•‘" -ForegroundColor Green
          Write-Host "â•‘  âœ… Auto-reload: Every 50 seconds      â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          
          # Start now
          Start-Process "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File C:\StartGartic.ps1"
          
          # Keep alive
          while ($true) { Start-Sleep -Seconds 300 }
