name: Gartic RDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  gartic-bot:
    runs-on: windows-2019
    timeout-minutes: 360
    strategy:
      matrix:
        node: [1, 2]
    
    steps:
      - name: Setup RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

      - name: Create User
        run: |
          net user saif123 admin@123 /add
          net localgroup administrators saif123 /add
          net localgroup "Remote Desktop Users" saif123 /add

      - name: Create Pages
        run: |
          New-Item -Path "C:\T" -ItemType Directory -Force
          @'
          <!DOCTYPE html><html><head><meta charset="UTF-8"><title>Token</title><style>body{background:#000;color:#0f0;font-family:monospace;padding:20px}.b{background:#111;padding:15px;margin:10px 0;border:1px solid #0f0}.n{font-size:35px;font-weight:bold}</style></head><body><div class="b"><h1>Token Fetcher</h1><p>Sent: <span class="n" id="c">0</span></p><p>Timer: <span class="n" id="t">50</span>s</p></div><div class="b" id="l"></div><script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script><script>var n=0,r=50;function g(m){document.getElementById('l').innerHTML='['+new Date().toLocaleTimeString()+'] '+m+'<br>'+document.getElementById('l').innerHTML}function s(t,i){if(!t||t.length<20)return;fetch('https://www.xsw.work.gd/add-token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:t})}).then(function(x){if(x.ok){n++;document.getElementById('c').innerText=n;g('W'+i+': #'+n)}}).catch(function(){})}window.addEventListener('message',function(e){if(e.data&&e.data.t)s(e.data.t,e.data.i)});for(var i=0;i<6;i++){var f=document.createElement('iframe');f.style.display='none';f.sandbox='allow-scripts allow-same-origin';document.body.appendChild(f);f.srcdoc='<!DOCTYPE html><html><head><script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script></head><body><div id="x"></div><script>var w='+i+';function go(){if(!window.turnstile){setTimeout(go,100);return}try{window.turnstile.render("#x",{sitekey:"0x4AAAAAABBPKaIbNwnPEfSo",callback:function(t){parent.postMessage({t:t,i:w},"*")}})}catch(e){}}setInterval(function(){if(window.turnstile)try{window.turnstile.reset("#x")}catch(e){}},3500);setTimeout(go,'+(100+i*50)+');</script></body></html>'}setInterval(function(){r--;document.getElementById('t').innerText=r;if(r<=0)location.reload()},1000);g('Start')</script></body></html>
          '@ | Out-File "C:\T\1.html" -Encoding UTF8
          @'
          <!DOCTYPE html><html><head><meta charset="UTF-8"><title>Token</title><style>body{background:#000;color:#0f0;font-family:monospace;padding:20px}.b{background:#111;padding:15px;margin:10px 0;border:1px solid #0f0}.n{font-size:35px;font-weight:bold}</style></head><body><div class="b"><h1>Token Fetcher</h1><p>Sent: <span class="n" id="c">0</span></p><p>Timer: <span class="n" id="t">50</span>s</p></div><div class="b" id="l"></div><script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script><script>var n=0,r=50;function g(m){document.getElementById('l').innerHTML='['+new Date().toLocaleTimeString()+'] '+m+'<br>'+document.getElementById('l').innerHTML}function s(t,i){if(!t||t.length<20)return;fetch('https://www.xsw.work.gd/add-token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:t})}).then(function(x){if(x.ok){n++;document.getElementById('c').innerText=n;g('W'+i+': #'+n)}}).catch(function(){})}window.addEventListener('message',function(e){if(e.data&&e.data.t)s(e.data.t,e.data.i)});for(var i=0;i<6;i++){var f=document.createElement('iframe');f.style.display='none';f.sandbox='allow-scripts allow-same-origin';document.body.appendChild(f);f.srcdoc='<!DOCTYPE html><html><head><script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script></head><body><div id="x"></div><script>var w='+i+';function go(){if(!window.turnstile){setTimeout(go,100);return}try{window.turnstile.render("#x",{sitekey:"0x4AAAAAABBPKaIbNwnPEfSo",callback:function(t){parent.postMessage({t:t,i:w},"*")}})}catch(e){}}setInterval(function(){if(window.turnstile)try{window.turnstile.reset("#x")}catch(e){}},3500);setTimeout(go,'+(100+i*50)+');</script></body></html>'}setInterval(function(){r--;document.getElementById('t').innerText=r;if(r<=0)location.reload()},1000);g('Start')</script></body></html>
          '@ | Out-File "C:\T\2.html" -Encoding UTF8

      - name: Create Script
        run: |
          @"
          timeout 5
          start firefox file:///C:/T/1.html
          timeout 2
          start firefox file:///C:/T/2.html
          "@ | Out-File "C:\run.bat" -Encoding ASCII

      - name: Auto Start
        run: |
          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v TokenFetcher /t REG_SZ /d "C:\run.bat" /f

      - name: Install Tailscale
        run: |
          curl -o $env:TEMP\ts.exe https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe
          Start-Process $env:TEMP\ts.exe -ArgumentList "/quiet" -Wait
          timeout 5
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=g${{ matrix.node }}

      - name: Info
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "`n================================" -ForegroundColor Cyan
          Write-Host "  NODE ${{ matrix.node }}" -ForegroundColor Green
          Write-Host "  IP: $ip" -ForegroundColor Yellow
          Write-Host "  User: saif123" -ForegroundColor Yellow
          Write-Host "  Pass: admin@123" -ForegroundColor Yellow
          Write-Host "================================`n" -ForegroundColor Cyan

      - name: Start
        run: C:\run.bat

      - name: Keep
        run: while($true){sleep 300}
