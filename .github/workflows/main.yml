name: Ultimate Gartic Token Machine
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  gartic-bot:
    runs-on: windows-2019
    timeout-minutes: 360
    strategy:
      matrix:
        rdp_node: [1, 2]
    
    steps:
      - name: Step 1 - Configure RDP Network
        run: |
          Write-Host "ğŸ”§ Configuring RDP..." -ForegroundColor Cyan
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          netsh advfirewall firewall add rule name="RDP-Allow" dir=in action=allow protocol=TCP localport=3389
          Write-Host "âœ… RDP Configured!" -ForegroundColor Green

      - name: Step 2 - Create Administrator User
        run: |
          Write-Host "ğŸ‘¤ Creating RDP User..." -ForegroundColor Cyan
          $password = "admin@123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (Get-LocalUser -Name "saif123" -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name "saif123" -ErrorAction SilentlyContinue
          }
          
          New-LocalUser -Name "saif123" -Password $securePass -FullName "Saif Admin" -Description "RDP Admin User" -AccountNeverExpires -PasswordNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "saif123" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "saif123" -ErrorAction SilentlyContinue
          
          Set-LocalUser -Name "saif123" -PasswordNeverExpires $true
          Write-Host "âœ… User 'saif123' Created!" -ForegroundColor Green

      - name: Step 3 - Optimize Windows Performance
        run: |
          Write-Host "âš¡ Optimizing Windows..." -ForegroundColor Cyan
          
          # Disable Windows Defender (for performance)
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          
          # Disable Windows Updates
          Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue
          Set-Service -Name wuauserv -StartupType Disabled -ErrorAction SilentlyContinue
          
          # Disable unnecessary services
          $services = @('DiagTrack', 'dmwappushservice', 'SysMain')
          foreach ($svc in $services) {
              Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
              Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
          }
          
          # Set High Performance Power Plan
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          Write-Host "âœ… Windows Optimized!" -ForegroundColor Green

      - name: Step 4 - Create Token Fetcher HTML Files
        run: |
          Write-Host "ğŸ“„ Creating Token Fetcher Pages..." -ForegroundColor Cyan
          
          New-Item -ItemType Directory -Force -Path "C:\TokenFetcher" | Out-Null
          
          $htmlTemplate = @'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gartic Token Fetcher - Instance {INSTANCE}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
        }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #00ff88;
            padding-left: 10px;
        }
        .status-online {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Gartic Token Fetcher - Instance {INSTANCE}</h1>
            <p><span class="status-online"></span> Status: <span id="status">Active</span></p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š Tokens Sent</div>
                <div class="stat-value" id="tokenCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ”„ Auto-Reload In</div>
                <div class="stat-value" id="reloadTimer">50</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">âš¡ Active Workers</div>
                <div class="stat-value" id="workerCount">6</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸŒ Backend Status</div>
                <div class="stat-value" id="backendStatus">âœ…</div>
            </div>
        </div>
        
        <div class="log" id="logContainer">
            <div class="log-entry">ğŸŸ¢ System initialized...</div>
        </div>
    </div>
    
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    
    <script>
    (function() {
        'use strict';
        
        // Configuration
        const CONFIG = {
            TOKEN_INTERVAL: 3500,
            NUM_WORKERS: 6,
            RELOAD_INTERVAL: 50000,
            BACKEND_URL: 'https://www.xsw.work.gd/add-token',
            TURNSTILE_SITEKEY: '0x4AAAAAABBPKaIbNwnPEfSo'
        };
        
        // State
        let tokenCount = 0;
        let reloadTimer = 50;
        let workerStatus = new Array(CONFIG.NUM_WORKERS).fill(false);
        
        // DOM Elements
        const elements = {
            tokenCount: document.getElementById('tokenCount'),
            reloadTimer: document.getElementById('reloadTimer'),
            workerCount: document.getElementById('workerCount'),
            backendStatus: document.getElementById('backendStatus'),
            logContainer: document.getElementById('logContainer')
        };
        
        // Logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'ğŸ”µ';
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${timestamp}] ${emoji} ${message}`;
            elements.logContainer.insertBefore(entry, elements.logContainer.firstChild);
            
            // Keep only last 50 entries
            while (elements.logContainer.children.length > 50) {
                elements.logContainer.removeChild(elements.logContainer.lastChild);
            }
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Update UI
        function updateUI() {
            elements.tokenCount.textContent = tokenCount;
            elements.reloadTimer.textContent = reloadTimer;
            elements.workerCount.textContent = workerStatus.filter(s => s).length + '/' + CONFIG.NUM_WORKERS;
        }
        
        // Send token to backend
        async function sendToken(token, workerId) {
            if (typeof token !== 'string' || token.length <= 20) {
                log(`Worker ${workerId}: Invalid token format`, 'error');
                return false;
            }
            
            try {
                const response = await fetch(CONFIG.BACKEND_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ token }),
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    tokenCount++;
                    updateUI();
                    log(`Worker ${workerId}: Token sent successfully (#${tokenCount})`, 'success');
                    elements.backendStatus.textContent = 'âœ…';
                    return true;
                } else {
                    log(`Worker ${workerId}: Backend error ${response.status}`, 'error');
                    elements.backendStatus.textContent = 'âš ï¸';
                    return false;
                }
            } catch (error) {
                log(`Worker ${workerId}: Network error - ${error.message}`, 'error');
                elements.backendStatus.textContent = 'âŒ';
                return false;
            }
        }
        
        // Create Turnstile worker
        function createWorker(workerId) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.sandbox = 'allow-scripts allow-same-origin';
            iframe.id = `worker-${workerId}`;
            document.body.appendChild(iframe);
            
            const workerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer><\/script>
                </head>
                <body>
                    <div id="turnstile-container"></div>
                    <script>
                        let isReady = false;
                        
                        function initTurnstile() {
                            if (!window.turnstile) {
                                setTimeout(initTurnstile, 100);
                                return;
                            }
                            
                            try {
                                window.turnstile.render('#turnstile-container', {
                                    sitekey: '${CONFIG.TURNSTILE_SITEKEY}',
                                    callback: function(token) {
                                        parent.postMessage({
                                            type: 'token',
                                            workerId: ${workerId},
                                            token: token
                                        }, '*');
                                    },
                                    'error-callback': function() {
                                        parent.postMessage({
                                            type: 'error',
                                            workerId: ${workerId}
                                        }, '*');
                                    }
                                });
                                
                                parent.postMessage({
                                    type: 'ready',
                                    workerId: ${workerId}
                                }, '*');
                                
                                isReady = true;
                            } catch (error) {
                                parent.postMessage({
                                    type: 'error',
                                    workerId: ${workerId},
                                    message: error.message
                                }, '*');
                            }
                        }
                        
                        // Auto-refresh worker
                        setInterval(() => {
                            if (isReady && window.turnstile) {
                                try {
                                    window.turnstile.reset('#turnstile-container');
                                } catch (e) {}
                            }
                        }, ${CONFIG.TOKEN_INTERVAL});
                        
                        setTimeout(initTurnstile, ${100 + workerId * 50});
                    <\/script>
                </body>
                </html>
            `;
            
            iframe.srcdoc = workerHTML;
            log(`Worker ${workerId}: Initialized`);
        }
        
        // Message handler
        window.addEventListener('message', async function(event) {
            if (!event.data || typeof event.data !== 'object') return;
            
            const { type, workerId, token, message } = event.data;
            
            switch (type) {
                case 'ready':
                    workerStatus[workerId] = true;
                    updateUI();
                    log(`Worker ${workerId}: Ready`);
                    break;
                    
                case 'token':
                    await sendToken(token, workerId);
                    break;
                    
                case 'error':
                    workerStatus[workerId] = false;
                    updateUI();
                    log(`Worker ${workerId}: Error - ${message || 'Unknown'}`, 'error');
                    break;
            }
        });
        
        // Reload timer
        setInterval(() => {
            reloadTimer--;
            updateUI();
            
            if (reloadTimer <= 0) {
                log('ğŸ”„ Auto-reloading page...');
                setTimeout(() => location.reload(), 500);
            }
        }, 1000);
        
        // Initialize workers
        function initializeWorkers() {
            log(`ğŸš€ Starting ${CONFIG.NUM_WORKERS} workers...`);
            
            for (let i = 0; i < CONFIG.NUM_WORKERS; i++) {
                setTimeout(() => createWorker(i), i * 200);
            }
        }
        
        // Start system
        setTimeout(initializeWorkers, 1000);
        log('âœ… Token Fetcher System Online');
        
    })();
    </script>
</body>
</html>
'@
          
          # Create 2 instances
          for ($i = 1; $i -le 2; $i++) {
              $html = $htmlTemplate -replace '{INSTANCE}', $i
              $html | Out-File "C:\TokenFetcher\instance$i.html" -Encoding UTF8
          }
          
          Write-Host "âœ… Created 2 Token Fetcher Instances!" -ForegroundColor Green

      - name: Step 5 - Create Auto-Start PowerShell Script
        run: |
          Write-Host "ğŸ“ Creating Startup Script..." -ForegroundColor Cyan
          
          $startupScript = @'
# ========================================
# Gartic Token Fetcher - Auto Startup
# ========================================

Start-Sleep -Seconds 5

$firefox = "C:\Program Files\Mozilla Firefox\firefox.exe"

# Check if Firefox exists
if (!(Test-Path $firefox)) {
    Write-Host "Firefox not found!" -ForegroundColor Red
    exit 1
}

# Launch Instance 1
Write-Host "ğŸš€ Launching Instance 1..." -ForegroundColor Cyan
Start-Process $firefox -ArgumentList "file:///C:/TokenFetcher/instance1.html"

# Wait
Start-Sleep -Seconds 3

# Launch Instance 2
Write-Host "ğŸš€ Launching Instance 2..." -ForegroundColor Cyan
Start-Process $firefox -ArgumentList "file:///C:/TokenFetcher/instance2.html"

Write-Host "âœ… Both instances launched!" -ForegroundColor Green
'@
          
          $startupScript | Out-File "C:\StartTokenFetcher.ps1" -Encoding UTF8
          
          Write-Host "âœ… Startup Script Created!" -ForegroundColor Green

      - name: Step 6 - Create Windows Scheduled Task
        run: |
          Write-Host "â° Creating Scheduled Task..." -ForegroundColor Cyan
          
          # Remove existing task if exists
          Unregister-ScheduledTask -TaskName "GarticTokenFetcher" -Confirm:$false -ErrorAction SilentlyContinue
          
          # Create action
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -File C:\StartTokenFetcher.ps1"
          
          # Create trigger (at logon)
          $trigger = New-ScheduledTaskTrigger -AtLogOn -User "saif123"
          
          # Create settings
          $settings = New-ScheduledTaskSettingsSet `
              -AllowStartIfOnBatteries `
              -DontStopIfGoingOnBatteries `
              -StartWhenAvailable `
              -ExecutionTimeLimit (New-TimeSpan -Hours 0) `
              -RestartCount 3 `
              -RestartInterval (New-TimeSpan -Minutes 1)
          
          # Register task
          Register-ScheduledTask `
              -TaskName "GarticTokenFetcher" `
              -Action $action `
              -Trigger $trigger `
              -Settings $settings `
              -User "saif123" `
              -RunLevel Highest `
              -Force
          
          Write-Host "âœ… Scheduled Task Created!" -ForegroundColor Green

      - name: Step 7 - Install and Configure Tailscale
        run: |
          Write-Host "ğŸŒ Installing Tailscale..." -ForegroundColor Cyan
          
          $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          $installerPath = "$env:TEMP\tailscale-setup.exe"
          
          # Download
          Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath -UseBasicParsing
          
          # Install silently
          Start-Process $installerPath -ArgumentList "/quiet", "/norestart" -Wait -NoNewWindow
          
          # Wait for service
          Start-Sleep -Seconds 5
          
          # Connect to Tailscale
          $tailscalePath = "C:\Program Files\Tailscale\tailscale.exe"
          
          if (Test-Path $tailscalePath) {
              & $tailscalePath up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gartic-node-${{ matrix.rdp_node }}" --accept-routes
              Write-Host "âœ… Tailscale Connected!" -ForegroundColor Green
          } else {
              Write-Host "âŒ Tailscale installation failed!" -ForegroundColor Red
          }

      - name: Step 8 - Configure Windows Firewall
        run: |
          Write-Host "ğŸ”¥ Configuring Firewall..." -ForegroundColor Cyan
          
          # Allow Firefox
          New-NetFirewallRule -DisplayName "Firefox-Allow" -Direction Inbound -Program "C:\Program Files\Mozilla Firefox\firefox.exe" -Action Allow -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "Firefox-Allow-Out" -Direction Outbound -Program "C:\Program Files\Mozilla Firefox\firefox.exe" -Action Allow -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Firewall Configured!" -ForegroundColor Green

      - name: Step 9 - Create Desktop Shortcuts
        run: |
          Write-Host "ğŸ–¥ï¸ Creating Desktop Shortcuts..." -ForegroundColor Cyan
          
          $desktop = "C:\Users\saif123\Desktop"
          New-Item -ItemType Directory -Force -Path $desktop | Out-Null
          
          # Create shortcut for manual launch
          $shell = New-Object -ComObject WScript.Shell
          $shortcut = $shell.CreateShortcut("$desktop\Start Token Fetcher.lnk")
          $shortcut.TargetPath = "powershell.exe"
          $shortcut.Arguments = "-ExecutionPolicy Bypass -File C:\StartTokenFetcher.ps1"
          $shortcut.IconLocation = "C:\Program Files\Mozilla Firefox\firefox.exe"
          $shortcut.Save()
          
          Write-Host "âœ… Desktop Shortcuts Created!" -ForegroundColor Green

      - name: Step 10 - Get RDP Connection Info
        run: |
          Write-Host ""
          Write-Host "Waiting for Tailscale IP..." -ForegroundColor Yellow
          Start-Sleep -Seconds 10
          
          $tailscalePath = "C:\Program Files\Tailscale\tailscale.exe"
          
          if (Test-Path $tailscalePath) {
              $ip = & $tailscalePath ip -4
              
              Write-Host ""
              Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
              Write-Host "â•‘                                                    â•‘" -ForegroundColor Cyan
              Write-Host "â•‘          ğŸš€ RDP NODE ${{ matrix.rdp_node }} - READY!                   â•‘" -ForegroundColor Green
              Write-Host "â•‘                                                    â•‘" -ForegroundColor Cyan
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
              Write-Host "â•‘                                                    â•‘" -ForegroundColor Cyan
              Write-Host "â•‘  ğŸ“¡ IP Address:    $ip                â•‘" -ForegroundColor Yellow
              Write-Host "â•‘  ğŸ‘¤ Username:      saif123                         â•‘" -ForegroundColor Yellow
              Write-Host "â•‘  ğŸ” Password:      admin@123                       â•‘" -ForegroundColor Yellow
              Write-Host "â•‘                                                    â•‘" -ForegroundColor Cyan
              Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
              Write-Host "â•‘                                                    â•‘" -ForegroundColor Cyan
              Write-Host "â•‘  âœ… Auto-Start:     ENABLED                        â•‘" -ForegroundColor Green
              Write-Host "â•‘  âœ… Token Workers:  2 Instances x 6 Workers (12)   â•‘" -ForegroundColor Green
              Write-Host "â•‘  âœ… Auto-Reload:    Every 50 seconds               â•‘" -ForegroundColor Green
              Write-Host "â•‘  âœ… Backend:        xsw.work.gd/add-token          â•‘" -ForegroundColor Green
              Write-Host "â•‘                                                    â•‘" -ForegroundColor Cyan
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
              Write-Host ""
              
              # Also output as GitHub annotation
              Write-Host "::notice title=RDP Node ${{ matrix.rdp_node }} Ready::IP: $ip | User: saif123 | Pass: admin@123"
          } else {
              Write-Host "âš ï¸ Tailscale not found - using fallback" -ForegroundColor Yellow
          }

      - name: Step 11 - Launch Token Fetcher NOW
        run: |
          Write-Host "ğŸš€ Launching Token Fetcher..." -ForegroundColor Cyan
          
          Start-Process "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File C:\StartTokenFetcher.ps1" -NoNewWindow
          
          Start-Sleep -Seconds 5
          
          # Verify Firefox is running
          $firefoxProcesses = Get-Process firefox -ErrorAction SilentlyContinue
          
          if ($firefoxProcesses) {
              Write-Host "âœ… Firefox is running with $($firefoxProcesses.Count) process(es)" -ForegroundColor Green
          } else {
              Write-Host "âš ï¸ Firefox not detected - may take a moment to start" -ForegroundColor Yellow
          }

      - name: Step 12 - Keep Alive Forever
        run: |
          Write-Host ""
          Write-Host "â™¾ï¸  System is now running..." -ForegroundColor Cyan
          Write-Host "   RDP will auto-restart Firefox on reconnect" -ForegroundColor Gray
          Write-Host "   Press Ctrl+C in Actions to stop (not recommended)" -ForegroundColor Gray
          Write-Host ""
          
          # Keep the job alive
          while ($true) {
              Start-Sleep -Seconds 300
              
              # Health check
              $firefox = Get-Process firefox -ErrorAction SilentlyContinue
              if ($firefox) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] âœ… Firefox running - $($firefox.Count) process(es)" -ForegroundColor Green
              } else {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] âš ï¸ Firefox not running" -ForegroundColor Yellow
              }
          }
